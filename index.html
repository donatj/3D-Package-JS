<!doctype html>
<html lang="en">
<head>
<title>Canvas</title>
<script src="https://ajax.googleapis.com/ajax/libs/mootools/1.3.2/mootools-yui-compressed.js"></script>
<script src="animationFrame.js"></script>
<script>
var xinc = 0;
var modelData;


var Point3D = function( x, y, z ) {
	this.x = x;
	this.y = y;
	this.z = z;
};

Point3D.prototype = {
	rotateX: function( angle ) {
		var rad = angle * Math.PI / 180;
		var cosa = Math.cos(rad);
		var sina = Math.sin(rad);
		var y = this.y * cosa - this.z * sina;
		var z = this.y * sina + this.z * cosa;
		return new Point3D(this.x, y, z);
	},

	rotateY: function( angle ) {
		var rad = angle * Math.PI / 180;
		var cosa = Math.cos(rad);
		var sina = Math.sin(rad);
		var z = this.z * cosa - this.x * sina;
		var x = this.z * sina + this.x * cosa;
		return new Point3D(x, this.y, z)
	},

	rotateZ: function( angle ) {
		var rad = angle * Math.PI / 180;
		var cosa = Math.cos(rad);
		var sina = Math.sin(rad);
		var x = this.x * cosa - this.y * sina;
		var y = this.x * sina + this.y * cosa;
		return new Point3D(x, y, this.z);
	},

	project: function( width, height, fov, viewerDistance ) {
		var factor = parseFloat(fov) / (viewerDistance + this.z);
		var x = this.x * factor + width / 2;
		var y = (0 - this.y) * factor + height / 2;
		return new Point3D(x, y, this.z);
	}
};


var Polygon3D = function(){
	this.points = [];

	for( var i = 0; i < arguments.length; i++ ) {
		this.points.push(arguments[i]);
	}
};

Polygon3D.prototype = {
	pushPoint3D: function() {
		for( var i = 0; i < arguments.length; i++ ) {
			this.points.push(arguments[i]);
		}
	},

	rotateX: function( angle ) {
		var poly = new Polygon3D();

		for( var p_i = 0; p_i < this.points.length; p_i++ ) {
			poly.pushPoint3D(this.points[p_i].rotateX(angle));
		}

		return poly;
	},

	rotateY: function( angle ) {
		var poly = new Polygon3D();

		for( var p_i = 0; p_i < this.points.length; p_i++ ) {
			poly.pushPoint3D(this.points[p_i].rotateY(angle));
		}

		return poly;
	},

	rotateZ: function( angle ) {
		var poly = new Polygon3D();

		for( var p_i = 0; p_i < this.points.length; p_i++ ) {
			poly.pushPoint3D(this.points[p_i].rotateZ(angle));
		}

		return poly;
	},

	project: function( width, height, fov, viewerDistance ) {
		var poly = new Polygon3D();

		for( var p_i = 0; p_i < this.points.length; p_i++ ) {
			poly.pushPoint3D(this.points[p_i].project(width, height, fov, viewerDistance));
		}

		return poly;
	}
};


var Model3D = function(){
	this.polygons = [];

	for( var i = 0; i < arguments.length; i++ ) {
		this.polygons.push(arguments[i]);
	}
};

Model3D.prototype = {
	pushPolygon3D: function() {
		for( var i = 0; i < arguments.length; i++ ) {
			this.polygons.push(arguments[i]);
		}
	},

	rotateX: function( angle ) {
		var model = new Model3D();

		for( var p_i = 0; p_i < this.polygons.length; p_i++ ) {
			model.pushPolygon3D(this.polygons[p_i].rotateX(angle));
		}

		return model;
	},

	rotateY: function( angle ) {
		var model = new Model3D();

		for( var p_i = 0; p_i < this.polygons.length; p_i++ ) {
			model.pushPolygon3D(this.polygons[p_i].rotateY(angle));
		}

		return model;
	},

	rotateZ: function( angle ) {
		var model = new Model3D();

		for( var p_i = 0; p_i < this.polygons.length; p_i++ ) {
			model.pushPolygon3D(this.polygons[p_i].rotateZ(angle));
		}

		return model;
	},

	project: function( width, height, fov, viewerDistance ) {
		var model = new Model3D();

		for( var p_i = 0; p_i < this.polygons.length; p_i++ ) {
			model.pushPolygon3D(this.polygons[p_i].project(width, height, fov, viewerDistance));
		}

		return model;
	}
};

var colors = [];

var renderModel3D = function( model ) {

	for( var poly_i = 0; poly_i < model.polygons.length; poly_i++ ) {
//		console.log(poly.points[0].x, poly.points.length);

		var poly = model.polygons[poly_i];

		c2.fillStyle = colors[ poly_i % colors.length  ];
		c2.beginPath();
		c2.moveTo(poly.points[0].x, poly.points[0].y);
		c2.lineTo(poly.points[1].x, poly.points[1].y);
		c2.lineTo(poly.points[2].x, poly.points[2].y);
		c2.closePath();
		c2.fill();

	}
};

var createModelFromPoints = function( modelData ) {

	var model = new Model3D();

	modelData.each(function( face, f_i ) {

		var polyface = new Polygon3D(
				new Point3D(face[0], face[1], face[2]),
				new Point3D(face[3], face[4], face[5]),
				new Point3D(face[6], face[7], face[8])
		);

		model.pushPolygon3D(polyface);

	});

	return model;
};

// var world_increment = 0;

var world = [];

function Render(time) {

	var world_increment = time / 50;
	
	//ie hack

	canvas.width = canvas.width + 0;

	var angleX = -35 + world_increment;
	var angleZ = 15 + world_increment * .8;
	var angleY = -30 + world_increment + .5;

	var img_width = 600;
	var img_height = 600;

	world.each(function( model ) {
		var projected_model = model.rotateX(angleX).rotateY(angleY).rotateZ(angleZ).project(img_width, img_height, 256, 30);
		renderModel3D(projected_model);
	});

	// world_increment += 1.4;

}

function loadModel(filename) {
	var modelData;
	new Request.JSON({url: filename, async: false, onSuccess: function( data ) {
		modelData = data;
	}}).get();

	Object.each(modelData, function( e ) {
		world.push(createModelFromPoints(e));
	});
}


window.onload = function() {

	canvas = document.getElementById("xcanvas");
	c2 = canvas.getContext("2d");

	// for( var i = 0; i <= 255; i++ ) {
	// 	colors.push( 'rgba('+ parseInt((Math.sin(i / 100) * 255) + 50, 10) +',0,0,0.3)' );
	// }

	// colors = [ '#00F', '#0F0', '#F00', '#FF0', '#F0F', '#0FF', '#FAF', '#AFF', '#FFA'];

	colors = ['rgba(255,0,0,0.2)'];

	loadModel('models/cat.json');
	loadModel('models/wineglass2.json');

	(function animloop(time){
	  window.requestAnimationFrame(animloop);
	  Render(time);
	})();

	// Render.periodical(20);
}
</script>
</head>
<body>
<canvas id="xcanvas" width="600" height="600" />
</body>
</html>